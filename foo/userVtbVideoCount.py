# coding=utf-8
import datetime
import time

import pymysql
from retrying import retry

tagIdList = "6401936," \
"6329812," \
"6576064," \
"3518240," \
"6323468," \
"4429874," \
"3565032," \
"4369064," \
"4242992," \
"6292538," \
"1099778," \
"3232987," \
"7100540," \
"7103122," \
"3284958," \
"7223122," \
"7388730," \
"7199208," \
"5241782," \
"7562902," \
"8751822," \
"7416760," \
"14104," \
"7599230," \
"5669354," \
"3390944," \
"7355391," \
"7715585," \
"8228054," \
"5272846," \
"7635176," \
"24878," \
"7960745," \
"7414788," \
"2944503," \
"6341310," \
"4371122," \
"5272848," \
"7396234," \
"7380716," \
"5849872," \
"7690222," \
"7550600," \
"1136873," \
"5627134," \
"7355372," \
"7718027," \
"3265114," \
"8255041," \
"5688532," \
"9708764," \
"5768558," \
"4852250," \
"7761795," \
"7395977," \
"6292536," \
"7515867," \
"4336340," \
"7296342," \
"7100596," \
"1106561," \
"7380714," \
"429195," \
"4578610," \
"6687348," \
"7851564," \
"8194474," \
"5719064," \
"181154," \
"7830402," \
"6001742," \
"7003826," \
"8065515," \
"6519906," \
"7734175," \
"7737086," \
"5674016," \
"8932286," \
"7880982," \
"8048705," \
"7829221," \
"8269532," \
"8428521," \
"7433905," \
"201054," \
"8269531," \
"9152844," \
"6854712," \
"9120291," \
"7599231," \
"8917981," \
"6628826," \
"7973208," \
"4859," \
"7833176," \
"7298417," \
"7515327," \
"7715580," \
"6838564," \
"7408539," \
"7280421," \
"7490361," \
"6954538," \
"7650512," \
"6774706," \
"12095," \
"6273654," \
"110633," \
"9167687," \
"7790442," \
"394538," \
"7300506," \
"7101468," \
"7416759," \
"5681578," \
"8064538," \
"7210732," \
"9244640," \
"864064," \
"7100544," \
"7210730," \
"8778053," \
"2527717," \
"6700994," \
"6631178," \
"7413260," \
"7100918," \
"7101048," \
"7871082," \
"8324507," \
"32660," \
"5007682," \
"7246289," \
"184765," \
"7366809," \
"4705," \
"8881832," \
"7100834," \
"8047797," \
"8641239," \
"8692701," \
"6778508," \
"4822678," \
"7062," \
"6318216," \
"198881," \
"6358940," \
"784618," \
"7818315," \
"7361265," \
"8265499," \
"8564461," \
"6293158," \
"9102106," \
"7569723," \
"44471," \
"5458740," \
"7296404," \
"117280," \
"2594152," \
"7603185," \
"7939704," \
"8240633," \
"7868940," \
"6739876," \
"8302388," \
"9049123," \
"8774220," \
"8283204," \
"290," \
"7025602," \
"2429," \
"7443839," \
"5257340," \
"8223190," \
"3532109," \
"5768864," \
"7101194," \
"8474291," \
"6711438," \
"7300507," \
"9203633," \
"481435," \
"6462184," \
"5645054," \
"3063820," \
"5626002," \
"6693498," \
"9576096," \
"7735290," \
"3618832," \
"7262610," \
"7518237," \
"6332476," \
"7757430," \
"9244654," \
"2659549," \
"8682247," \
"7373249," \
"8909996," \
"6778414," \
"8688584," \
"7577264," \
"2624068," \
"5790660," \
"7349639," \
"7077928," \
"7694533," \
"8255039," \
"4429872," \
"5876422," \
"6560428," \
"1627542," \
"8293859," \
"6992956," \
"7681197," \
"7765444," \
"3151983," \
"6304230," \
"8225088," \
"5141432," \
"5876418," \
"7433904," \
"5876420," \
"8212406," \
"7046020," \
"7402290," \
"5876416," \
"6747204," \
"7202376," \
"9577792," \
"6594126," \
"6594128," \
"6594130," \
"1071234," \
"4005," \
"7393745," \
"7384360," \
"7362287," \
"377866," \
"2983," \
"7298470," \
"7522595," \
"6709350," \
"6904752," \
"7199206," \
"6708426," \
"2497455," \
"6555080," \
"9008218," \
"7101330," \
"7748498," \
"86271," \
"421428," \
"5775502," \
"8287916," \
"6728660," \
"6321410," \
"8890267," \
"8921257," \
"5275028," \
"8947412," \
"6470530," \
"7749167," \
"7764566," \
"76241," \
"2785731," \
"6872598," \
"9211405," \
"2541797," \
"7748496," \
"7160986," \
"8301009," \
"7303013," \
"7569724," \
"8300648," \
"7578453," \
"248528," \
"293764," \
"1328816," \
"8078632," \
"6872600," \
"8998173," \
"2556528," \
"6804354," \
"58748," \
"7925793," \
"3759382," \
"4050312," \
"3754938," \
"9089937," \
"9550188," \
"4329572," \
"7705945," \
"8866629," \
"8929932," \
"8256315," \
"7580272," \
"8935481," \
"8410323," \
"5318620," \
"8869169," \
"2808482," \
"1295779," \
"5755254," \
"7849652," \
"2532153," \
"8310532," \
"6770934," \
"7669081," \
"6553080," \
"7352889," \
"9606728," \
"7810038," \
"6945420," \
"7453305," \
"7280862," \
"7763240," \
"7587183," \
"7202446," \
"8610232," \
"6977448," \
"6758504," \
"1470376," \
"28959," \
"8610242," \
"8610231," \
"8234260," \
"7283990," \
"7945736," \
"9121829," \
"726022," \
"7298483," \
"2014280," \
"2987582," \
"7871568," \
"801928," \
"7588026," \
"1175105," \
"6894608," \
"7733332," \
"9127930," \
"5631974," \
"7940246," \
"7600202," \
"8255223," \
"7682449," \
"6778480," \
"8453463," \
"9687389," \
"8365760," \
"9076976," \
"7710152," \
"7895453," \
"6904848," \
"8875680," \
"3074267," \
"7396754," \
"8785416," \
"8526803," \
"866015," \
"7320767," \
"8780303," \
"491182," \
"6449790," \
"2911747," \
"5977754," \
"5734772," \
"7716530," \
"460190," \
"7799791," \
"6933184," \
"7322015," \
"9561," \
"8741325," \
"5983212," \
"7101382," \
"7388204," \
"6426170," \
"8398005," \
"3251320," \
"6449788," \
"797968," \
"70415," \
"409457," \
"6151048," \
"5687928," \
"1759576," \
"7635118," \
"6374818," \
"8981112," \
"1415638," \
"7863738," \
"5830212," \
"7431095," \
"6450228," \
"8274369," \
"9613945," \
"6541328," \
"8741858," \
"910279," \
"7319634," \
"3162832," \
"1051989," \
"8636588," \
"9041512," \
"313159," \
"147990," \
"8541906," \
"3651188," \
"1381458," \
"9110090," \
"6449864," \
"6576062," \
"6840150," \
"3395301," \
"6166106," \
"8880404," \
"7320880," \
"8914244," \
"1742465," \
"7577305," \
"5665182," \
"8364958," \
"8163462," \
"8654901," \
"6840148," \
"9782808," \
"5559382," \
"7563578," \
"8905968," \
"7619587," \
"6320730," \
"7973249," \
"8232533," \
"7739133," \
"8914858," \
"6573384," \
"8292957," \
"7840342," \
"7927693," \
"9718457," \
"8893401," \
"5700284," \
"8402119," \
"8884048," \
"28374," \
"6740914," \
"9160705," \
"8366157," \
"8743668," \
"8856264," \
"9620346," \
"9211297," \
"7369108," \
"9608131," \
"6695446," \
"9047894," \
"8264886," \
"8982048," \
"7464753," \
"2776197," \
"54148," \
"7871559," \
"9801929," \
"8224631," \
"8891773," \
"6390890," \
"144628," \
"7100658," \
"837622," \
"8894613," \
"8793376," \
"8406398," \
"9041006," \
"20744," \
"7716767," \
"9135870," \
"8437335," \
"8891793," \
"9018527," \
"7213150," \
"3317701," \
"9617291," \
"9857048," \
"2822261," \
"3113394," \
"7999720," \
"130389," \
"6564322," \
"4175412," \
"144899," \
"2673055," \
"8721986," \
"9097731," \
"7986836," \
"8259103," \
"9528286," \
"9570569," \
"9062246," \
"6911548," \
"7988881," \
"10012," \
"6450244," \
"6778506," \
"10024535," \
"9044068," \
"6966902," \
"1579260," \
"8441705," \
"4191632," \
"8003720," \
"133217," \
"9947476," \
"6873764," \
"10903," \
"4232814," \
"8810891," \
"7371304," \
"178877," \
"4962790," \
"6081328," \
"5178466," \
"4150994," \
"8682226," \
"7902721," \
"6429688," \
"8518349," \
"9714391," \
"6262096," \
"6613146," \
"3216763," \
"6631534," \
"7296772," \
"6631180," \
"7290121," \
"8050120," \
"8186850," \
"3110220," \
"2524692," \
"272810," \
"9970598," \
"8283596," \
"9095851," \
"2710326," \
"5637900," \
"8293641," \
"8434204," \
"7243428," \
"6720214," \
"9139293," \
"2805354," \
"148711," \
"5681264," \
"6775630," \
"243807," \
"63079," \
"7425396," \
"8252319," \
"3514280," \
"8079669," \
"108701," \
"7906382," \
"9031297," \
"201118," \
"7392071," \
"8746830," \
"7416734," \
"8254718," \
"7223124," \
"7660063," \
"6413048," \
"6832610," \
"77175," \
"7319305," \
"8214215," \
"6378132," \
"9672105," \
"5681226," \
"8632951," \
"1009," \
"6956416," \
"9122831," \
"3179528," \
"9033572," \
"9062316," \
"8962279," \
"7850297," \
"8938020," \
"7266781," \
"7801625," \
"9568293," \
"6313462," \
"34312," \
"9792855," \
"108641," \
"8857204," \
"7126356," \
"7681857," \
"9616958," \
"8642340," \
"8567407," \
"7653942," \
"7572102," \
"9787543," \
"6762580," \
"8881814," \
"3500905," \
"8495993," \
"9230379," \
"8125425," \
"8741077," \
"6217964," \
"6440458," \
"8978475," \
"446728," \
"8140406," \
"9532641," \
"32658," \
"6523444," \
"7758285," \
"8422706," \
"8309914," \
"1431289," \
"7168680," \
"1109657," \
"7509482," \
"3146789," \
"7580274," \
"5615744," \
"3272114," \
"6849422," \
"3491," \
"7715163," \
"3272115," \
"8647275," \
"8886734," \
"8914709," \
"3237022," \
"2314," \
"7679571," \
"7661192," \
"3562911," \
"9580491," \
"8822847," \
"2651712," \
"10060575," \
"9065978," \
"2534365," \
"9787522," \
"7302142," \
"6620922," \
"7018300," \
"9209374," \
"6548458," \
"9232219," \
"7528023," \
"9604193," \
"7935091," \
"7794203," \
"2748997," \
"439667," \
"8264585," \
"9054277," \
"9072323," \
"7205368," \
"9112385," \
"1370548," \
"6861232," \
"6096960," \
"8695580," \
"5181606," \
"8754672," \
"5799242," \
"8418424," \
"7881913," \
"8256415," \
"3508343," \
"6606868," \
"7155732," \
"5663816," \
"7403648," \
"5809006," \
"4352," \
"9240984," \
"8922896," \
"2692456," \
"2562951," \
"8264488," \
"8917398," \
"5681460," \
"271949," \
"8056056," \
"6284738," \
"6776132," \
"7659792," \
"9536297," \
"9555344," \
"455," \
"5974616," \
"7714993," \
"7466802," \
"7303564," \
"9671324," \
"41304," \
"8283661," \
"7466534," \
"8870388," \
"9156012," \
"7326483," \
"9081362," \
"8624965," \
"3000355," \
"7712017," \
"9582047," \
"1153992," \
"7814569," \
"121339," \
"7146660"

@retry(stop_max_attempt_number=99)
def userTvbVideo(item, db, cursor, nowSum, totalSum, time_start):
    try:
        time_end = time.time()
        print('time cost:', time_end - time_start, 's now time:', datetime.datetime.fromtimestamp(time_end)),
        print("  第%d/%d个 目前进度%.4f%% 用户ID: %d" % (nowSum, totalSum, nowSum * 100 / totalSum, item[0]))
        sql = "update up_vtbvideo_pre set vtb_video_count = (select count(distinct(aid)) from video_tag where aid in ( " \
              "select aid from video_info where mid = %d ) and tid in (" % item[0]+ tagIdList + "" \
              ")) where mid = %d " % item[0]
        sql2 = "update user_info set vtb_count_flag = 1 where mid = %d" % item[0]
        cursor.execute(sql)
        cursor.execute(sql2)
        db.commit()

    except Exception as e:
        print(e)
        time.sleep(1)
        db.rollback()


@retry(stop_max_attempt_number=99)
def userTvbVideoList():
    db = pymysql.connect(host='localhost', user='root', passwd='root', db='vtb', port=3306, charset='utf8')
    cursor = db.cursor()
    searchSql1 = "select count(1) from user_info where vtb_count_flag = 1"
    cursor.execute(searchSql1)
    nowSum = cursor.fetchall()[0]
    sum = nowSum[0]
    searchSql2 = "select count(1) from user_info"
    cursor.execute(searchSql2)
    totalSum = cursor.fetchall()[0]
    time_start = time.time()
    while 1:
        searchSql = "select mid from user_info where vtb_count_flag is null or vtb_count_flag = 0 order by mid limit 50"
        cursor.execute(searchSql)
        results = cursor.fetchall()
        if len(results) == 0:
            break
        for item in results:
            sum += 1
            userTvbVideo(item, db, cursor, sum, totalSum[0], time_start)


userTvbVideoList()
